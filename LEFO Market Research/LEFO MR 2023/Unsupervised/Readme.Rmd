---
title: "Beberapa Contoh Metode Clustering dengan R"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Live-Session-Nutrifood-R/LEFO Market Research/LEFO MR 2023/Unsupervised")
```

# _Introduction_

Berikut adalah beberapa _showcase_ contoh penerapan metode _clustering_ dengan __R__.

# _K-Means Clustering_

```{r,include=FALSE}
rm(list=ls())

# libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(factoextra)
library(fpc)
library(dbscan)

```

## Contoh Kasus I

```{r,fig.align='center',fig.retina=4}
# import data
df = read.csv("~/Live-Session-Nutrifood-R/LEFO Market Research/LEFO MR 2023/Unsupervised/k means/compact disks.csv") %>% 
     janitor::clean_names() %>%
     select(-x) %>%
     rename(x = x_2)

# kita bikin visualisasinya terlebih dahulu
plt = 
  df %>%
  ggplot(aes(x,y)) +
  geom_point()
plt + coord_equal()

```

Jika melihat langsung data di atas, kita sudah bisa pastikan bahwa ada $k = 4$ buah _cluster_.

> Namun bagaimana jika kita gunakan _elbow method_ dan _silhouette method_ untuk menentukan berapa banyaknya $k$?

### _Elbow Method_

```{r}
elbow = fviz_nbclust(df, kmeans, method = "wss")
plot(elbow)
```

### _Silhouette Method_

```{r}
siluet = fviz_nbclust(df, kmeans, method = "silhouette")
plot(siluet)
```

### Kesimpulan Sementara

Penentuan $k$ menggunakan _elbow_ dan _silhouette method_ bisa berpotensi _miss leading_.

#### Jika $k=5$

```{r}
# k-means clustering
final = kmeans(df, 5, nstart = 25)

# center dari masing-masing cluster
final$centers

# save hasil cluster ke data awal
data_kmeans = df
data_kmeans$cluster = final$cluster

# berapa banyak isi dari cluster
table(data_kmeans$cluster)

plt = 
  data_kmeans %>%
  ggplot(aes(x,y)) +
  geom_point(aes(color = as.factor(cluster)))
plt

```

#### Jika $k=6$

```{r}
# k-means clustering
final = kmeans(df, 6, nstart = 25)

# center dari masing-masing cluster
final$centers

# save hasil cluster ke data awal
data_kmeans = df
data_kmeans$cluster = final$cluster

# berapa banyak isi dari cluster
table(data_kmeans$cluster)

plt = 
  data_kmeans %>%
  ggplot(aes(x,y)) +
  geom_point(aes(color = as.factor(cluster)))
plt

```


### Jawaban yang Benar

Seharusnya $k=4$.

```{r}
# k-means clustering
final = kmeans(df, 4, nstart = 25)

# center dari masing-masing cluster
final$centers

# save hasil cluster ke data awal
data_kmeans = df
data_kmeans$cluster = final$cluster

# berapa banyak isi dari cluster
table(data_kmeans$cluster)

plt = 
  data_kmeans %>%
  ggplot(aes(x,y)) +
  geom_point(aes(color = as.factor(cluster)))
plt

```

> Lantas bagaimana jika kita tidak bisa menentukan banyaknya $k$ secara visual dan hanya bisa mengandalkan _elbow_ dan _silhouette method_?

```{r,include=FALSE}
rm(list=ls())
```

## Contoh Kasus II

```{r,fig.align='center',fig.retina=4}
# import data
df = read.csv("~/Live-Session-Nutrifood-R/LEFO Market Research/LEFO MR 2023/Unsupervised/k means/dual disks.csv") %>% 
     janitor::clean_names() %>%
     select(-x) %>%
     rename(x = x_2)

# kita bikin visualisasinya terlebih dahulu
plt = 
  df %>%
  ggplot(aes(x,y)) +
  geom_point()
plt

```

Jika melihat langsung data di atas, kita sudah bisa pastikan bahwa ada $k = 2$ buah _cluster_.

> Namun bagaimana jika kita gunakan _elbow method_ dan _silhouette method_ untuk menentukan berapa banyaknya $k$?

### _Elbow Method_

```{r}
elbow = fviz_nbclust(df, kmeans, method = "wss")
plot(elbow)
```

### _Silhouette Method_

```{r}
siluet = fviz_nbclust(df, kmeans, method = "silhouette")
plot(siluet)
```

Kedua metode tersebut konklusif menyatakan $k=2$, sehingga:

```{r,fig.align='center',fig.retina=4}
# k-means clustering
final = kmeans(df, 2, nstart = 25)

# center dari masing-masing cluster
final$centers

# save hasil cluster ke data awal
data_kmeans = df
data_kmeans$cluster = final$cluster

# berapa banyak isi dari cluster
table(data_kmeans$cluster)

plt = 
  data_kmeans %>%
  ggplot(aes(x,y)) +
  geom_point(aes(color = as.factor(cluster)))
plt
```

Terlihat bahwa ada beberapa titik data yang _overlap_ masuk ke _cluster_ lainnya.

---

# _Hierarchical Clustering_

## Contoh I

```{r,fig.align='center',fig.retina=4}
rm(list=ls())
df = read.csv("~/Live-Session-Nutrifood-R/LEFO Market Research/LEFO MR 2023/Unsupervised/hierarchical/donat.csv") %>% 
     janitor::clean_names() %>%
     select(x_2,y) %>%
     rename(x = x_2)

# membuat grafik
plt = 
  df %>%
  ggplot(aes(x,y)) +
  geom_point()
plt

# Finding distance matrix
distance_mat = dist(df, method = 'euclidean')
```

### _Single Link_

```{r,fig.align='center',fig.retina=4}
# Fitting Hierarchical clustering Model
set.seed(240)  # Setting seed
Hierar_cl = hclust(distance_mat, method = "single")

plot(Hierar_cl)

# Pemecahan menjadi 3 cluster
fit = cutree(Hierar_cl, k = 3)
table(fit)
plot(Hierar_cl)
rect.hclust(Hierar_cl, k = 3, border = "red")

# save hasil cluster ke data awal
data_hc = df
data_hc$cluster = fit

# berapa banyak isi dari cluster
hie_plot = 
  data_hc %>%
  ggplot(aes(x,y,color = as.factor(cluster))) +
  geom_point()
hie_plot

```

### _Complete Link_

```{r,fig.align='center',fig.retina=4}
# Fitting Hierarchical clustering Model
set.seed(240)  # Setting seed
Hierar_cl = hclust(distance_mat, method = "complete")

plot(Hierar_cl)

# Pemecahan menjadi 3 cluster
fit = cutree(Hierar_cl, k = 6)
table(fit)
plot(Hierar_cl)
rect.hclust(Hierar_cl, k = 6, border = "red")

# save hasil cluster ke data awal
data_hc = df
data_hc$cluster = fit

# berapa banyak isi dari cluster
hie_plot = 
  data_hc %>%
  ggplot(aes(x,y,color = as.factor(cluster))) +
  geom_point()
hie_plot

```

### _Average Link_

```{r,fig.align='center',fig.retina=4}
# Fitting Hierarchical clustering Model
set.seed(240)  # Setting seed
Hierar_cl = hclust(distance_mat, method = "average")

plot(Hierar_cl)

# Pemecahan menjadi 3 cluster
fit = cutree(Hierar_cl, k = 4)
table(fit)
plot(Hierar_cl)
rect.hclust(Hierar_cl, k = 4, border = "red")

# save hasil cluster ke data awal
data_hc = df
data_hc$cluster = fit

# berapa banyak isi dari cluster
hie_plot = 
  data_hc %>%
  ggplot(aes(x,y,color = as.factor(cluster))) +
  geom_point()
hie_plot

```

## Contoh II

```{r,fig.align='center',fig.retina=4}
rm(list=ls())
df = read.csv("~/Live-Session-Nutrifood-R/LEFO Market Research/LEFO MR 2023/Unsupervised/hierarchical/hi.csv") %>% 
     janitor::clean_names() %>%
     select(x_2,y) %>%
     rename(x = x_2)

# membuat grafik
plt = 
  df %>%
  ggplot(aes(x,y)) +
  geom_point()
plt

# Finding distance matrix
distance_mat = dist(df, method = 'euclidean')
```

### _Single Link_

```{r,fig.align='center',fig.retina=4}
# Fitting Hierarchical clustering Model
set.seed(240)  # Setting seed
Hierar_cl = hclust(distance_mat, method = "single")

plot(Hierar_cl)

# Pemecahan menjadi 2 cluster
fit = cutree(Hierar_cl, k = 2)
table(fit)
plot(Hierar_cl)
rect.hclust(Hierar_cl, k = 2, border = "red")

# save hasil cluster ke data awal
data_hc = df
data_hc$cluster = fit

# berapa banyak isi dari cluster
hie_plot = 
  data_hc %>%
  ggplot(aes(x,y,color = as.factor(cluster))) +
  geom_point()
hie_plot

```

---

# _DBScan_

## Contoh I

```{r,fig.align='center',fig.retina=4}
rm(list=ls())

# ambil data
df = read.csv("~/Live-Session-Nutrifood-R/LEFO Market Research/LEFO MR 2023/Unsupervised/dbscan/donat density.csv") %>%
     janitor::clean_names() %>% 
     select(-x) %>% rename(x = x_2)

df |>
  ggplot(aes(x,y)) +
  geom_point()

```

Bagaimana agar kita bisa mendapatkan _cluster_ yang terbaik? Kita akan gunakan _DBScan_. Langkah pertama adalah menentukan `h` yang teroptimal saat grafik `NN distance`-nya meningkat tinggi.

```{r,fig.align='center',fig.retina=4}
dbscan::kNNdistplot(df, k = 30)
abline(h = .25, lty = 2, col = "red")
```

Kita akan pilih `h = .25`.

```{r,fig.align='center',fig.retina=4}
# membuat clustering DBScan
# set sed agar reproducible
set.seed(20921004)
Dbscan_cl = dbscan(df, eps = 0.25, minPts = 5)

# menambahkan cluster ke dalam dataset
df$cluster_new = Dbscan_cl$cluster

# menghitung ada berapa banyak cluster yang ada
df$cluster_new %>% unique() %>% length()

df |>
  ggplot(aes(x,y)) +
  geom_point(aes(color = as.factor(cluster_new)),
             size = 2)

```





